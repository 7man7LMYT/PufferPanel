{% extends "base.html" %}

{% block title %}File Manager{% endblock %}

{% block scripts %}
	{{ parent() }}
	<script type="text/javascript" src="{{ settings.assets_url }}javascript/jquery.redirect.min.js"></script>
{% endblock %}

{% block navdropdown %}
<div class="navbar-collapse navbar-responsive-collapse collapse" style="height: 1px;">
	<ul class="nav navbar-nav navbar-right">
		<li class="dropdown">
			<a href="#" class="dropdown-toggle" data-toggle="dropdown">{{ lang.header_account }}<b class="caret"></b></a>
				<ul class="dropdown-menu">
					<li><a href="{{ settings.master_url }}logout.php">{{ lang.header_logout }}</a></li>
					{% if admin %}<li><a href="{{ settings.master_url }}admin/index.php">{{ lang.header_admin }}</a></li>{% endif %}
				</ul>
		</li>
	</ul>
</div>
{% endblock %}

{% block sidebar %}
<div class="list-group">
	<a href="#" class="list-group-item list-group-item-heading"><strong>{{ lang.sidebar_acc_actions }}</strong></a>
	<a href="../../account.php" class="list-group-item">{{ lang.sidebar_settings }}</a>
	<a href="../../totp.php" class="list-group-item">TOTP {{ lang.sidebar_settings }}</a>
	<a href="../../servers.php" class="list-group-item">{{ lang.sidebar_servers }}</a>
</div>
<div class="list-group">
	<a href="#" class="list-group-item list-group-item-heading"><strong>{{ lang.sidebar_server_acc }}</strong></a>
	<a href="../index.php" class="list-group-item">{{ lang.sidebar_overview }}</a>
	<a href="../console.php" class="list-group-item">{{ lang.sidebar_console }}</a>
	<a href="index.php" class="list-group-item active">{{ lang.sidebar_files }}</a>
</div>
<div class="list-group">
	<a href="#" class="list-group-item list-group-item-heading"><strong>{{ lang.sidebar_server_sett }}</strong></a>
	
	<a href="../settings.php" class="list-group-item">{{ lang.sidebar_manage }}</a>
	<a href="../plugins/index.php" class="list-group-item">{{ lang.sidebar_plugins }}</a>
</div>
{% endblock %}

{% block content %}
<div class="col-9" id="internal_alert">
	<div class="alert alert-info">
		<i class="fa fa-spinner fa-spin"></i> {{ lang.node_files_loading }}
	</div>
</div>
<div class="row">
	<div class="col-9">
		<div class="files_loading_box"><i class="fa fa-refresh fa-spin" id="position_me"></i></div>
	</div>
	<div class="col-9" id="load_files"></div>
</div>
<script type="text/javascript">
$(window).load(function(){
    $.urlParam = function(name, url){
		 var results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(decodeURIComponent(url));
		 if (results==null){
		     return null;
         }else{
		     return results[1] || 0;
		 }
    }
    var doneLoad = false;
    function handleLoader(show){
    
    	if(show === true){
    		var height = $("#get_height").height();
    		var width = $(".files_loading_box").width();
    		var center_height = (height / 2) - 15;
    		var center_width = (width / 2) - 15;
    		$("#position_me").css({"top": center_height, "left": center_width});
    		$(".files_loading_box").css("height", (height + 5)).fadeIn();
    	}else{
    		$(".files_loading_box").fadeOut();
    	}
    	
    }
    function newLoad(){
        $("a.load_new").click(function(event){
            event.preventDefault();
            handleLoader(true);
	        if($.urlParam('dir', $(this).attr("href")) != null){
	            var dir = $.urlParam('dir', $(this).attr("href"));
	            $.ajax({
	                type: "POST",
	                url: '../ajax/files/list_dir.php',
	                data: {'dir': dir},
	                success: function(data) {
	                    $("#load_files").slideUp(function(){
	                        $("#load_files").html(data);
	                        handleLoader(false);
	                        $("#load_files").slideDown();
	                        newLoad();
	                    });
	                }
	            });
	        }else{
	            $.ajax({
	                type: "POST",
	                url: '../ajax/files/list_dir.php',
	                data: {},
	                success: function(data) {
	                    $("#load_files").slideUp(function(){
	                        $("#load_files").html(data);
	                        handleLoader(false);
	                        $("#load_files").slideDown();
	                        newLoad();
	                    });
	            	}
	            });
	        }
        });
        $("a.edit_file").click(function(event){
            event.preventDefault();
            var file = $.urlParam('file', $(this).attr("href"));
            $().redirect('edit.php', {'file': file});
        });
    }
    function firstLoad() {
    	$("#loading_dir").fadeIn(200);
		$("#internal_alert").slideDown();
        if($.urlParam('dir', $(location).attr('href')) != null && doneLoad === false){
        	var dir = $.urlParam('dir', $(location).attr('href'));
			$("#loading_dir").fadeIn(200);
        	$.ajax({
        	    type: "POST",
        	    url: '../ajax/files/list_dir.php',
        	    data: {'dir': dir},
        	    success: function(data) {
        	        $("#load_files").slideUp(function(){
        	            $("#load_files").html(data);
        	            $("#internal_alert").slideUp();
        	            $("#load_files").slideDown();
        	            $("#loading_dir").fadeOut(200);
        	            doneLoad = true;
        	            newLoad();
        	        });
        	    }
        	});
        }else{
	        $("#loading_dir").fadeIn(200);
	        $.ajax({
	            type: "POST",
	            url: '../ajax/files/list_dir.php',
	            data: {},
	            success: function(data) {
	                $("#load_files").slideUp(function(){
	                    $("#load_files").html(data);
	                    $("#internal_alert").slideUp();
	                    $("#load_files").slideDown();
	                    $("#loading_dir").fadeOut(200);
	                    doneLoad = true;
	                    newLoad();
	                });
	            }
	        });
        }
    }
    firstLoad();
});
</script>
{% endblock %}